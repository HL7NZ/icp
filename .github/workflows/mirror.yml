# this mirrors all changes from the icp to the icp-mirror repository

name: mirror

# sdfsdf
on:
  workflow_dispatch:
#     branches:  [ trunk ]
    
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
     
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.
          fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
      
#       - name: Configure SSH
#         run: |
#           mkdir -p ~/.ssh/
#           echo "$SSH_KEY" > ~/.ssh/staging.key
#           chmod 600 ~/.ssh/staging.key
#           cat >>~/.ssh/config <<END
#           Host staging
#             HostName $SSH_HOST
#             User $SSH_USER
#             IdentityFile ~/.ssh/staging.key
#             StrictHostKeyChecking no
#           END
#         env:
#           SSH_KEY: ${{ secrets.ID_ED25519 }}

# git push -u origin trunk
      - name: Configure remote and push
        run: |
          git remote rm origin
          git config --local user.email "acc-fhir-publisher@acc.co.nz"
          git config --local user.name "acc-fhir-publisher"
          git config --local user.password "${{ secrets.ICP_CLONE_PAT }}"
          git remote add origin https://acc-fhir-publisher:${{ secrets.ICP_CLONE_PAT }}@github.com/acc-fhir-publisher/icp-clone.git
          git pull
          git push --set-upstream origin trunk
